# Nexora - Real-time - Системный мониторинг и управление процессами

CLI-утилита для мониторинга и управления системными процессами с веб-интерфейсом. Поддерживает как интерактивное текстовое меню, так и REST API с WebSocket для потоковой передачи метрик в реальном времени.

## Содержание

- [Основные возможности](#основные-возможности)
- [Архитектура проекта](#архитектура-проекта)
- [Серверная часть (Web API)](#серверная-часть-web-api)
- [API Эндпоинты](#api-эндпоинты)
- [WebSocket Эндпоинты](#websocket-эндпоинты)
- [Технологический стек](#технологический-стек)
- [Запуск проекта](#запуск-проекта)

## Основные возможности

### CLI-режим

- Просмотр списка всех запущенных процессов с детальной информацией
- Завершение процессов по PID или по имени
- Поиск процессов по PID или названию
- Фоновый мониторинг процессов с превышением порога загрузки CPU
- Интерактивное текстовое меню

### Web-режим (HTTP Server)

- REST API для получения метрик системы
- WebSocket для потоковой передачи данных в реальном времени
- Управление состоянием мониторинга (включение/выключение)
- Завершение процессов через API

## Архитектура проекта

```
agent/
├── server/              # Серверная часть (Web API)
│   ├── api/             # Настройка HTTP-сервера и маршрутизация
│   │   ├── server.go    # Запуск сервера с graceful shutdown
│   │   └── routes.go    # Регистрация всех эндпоинтов
│   ├── handlers/        # HTTP-обработчики для REST API
│   │   ├── metrics.go   # Обработчики метрик (CPU, память, процессы)
│   │   ├── killProcessById.go  # Завершение процессов
│   │   └── monitoring.go # Управление состоянием мониторинга
│   ├── ws/              # WebSocket для потоковой передачи
│   │   └── ws.go        # Потоковая передача метрик в реальном времени
│   ├── getmetrics/      # Сбор системных метрик
│   │   ├── cpuMetrics.go      # Метрики CPU
│   │   ├── memoryMetrics.go   # Метрики памяти
│   │   └── processMetrics.go  # Информация о процессах
│   ├── models/          # Структуры данных
│   │   └── process.go  # Модели для API-ответов
│   └── middleware/      # Промежуточное ПО
│       └── corsMiddleware.go  # CORS middleware
├── cpu/                 # CLI-логика для работы с процессами
├── ui/                  # Интерфейс командной строки
├── utils/               # Вспомогательные утилиты
└── main.go              # Точка входа приложения
```

## Серверная часть (Web API)

### Архитектура серверной части

Серверная часть построена по модульной архитектуре с четким разделением ответственности:

#### 1. **Слой API (api/)**

- **server.go**: Инициализация и запуск HTTP-сервера
  - Поддержка graceful shutdown (корректное завершение работы)
  - Настройка таймаутов (ReadTimeout, WriteTimeout, IdleTimeout)
  - Обработка сигналов SIGTERM/SIGINT
- **routes.go**: Централизованная регистрация всех маршрутов
  - REST API эндпоинты
  - WebSocket эндпоинты
  - Единая точка конфигурации маршрутизации

#### 2. **Слой обработчиков (handlers/)**

- **metrics.go**: Обработчики для получения метрик
  - `GetCPU()` - получение метрик CPU
  - `GetMemory()` - получение метрик памяти
  - `GetProcesses()` - получение списка процессов
  - `GetHostUserName()` - получение системной информации
- **kill_process_by_id.go**: Управление процессами
  - `KillProcessById()` - завершение процесса по PID
  - Валидация PID и проверка существования процесса
- **monitoring.go**: Управление состоянием мониторинга
  - `SetMonitoringStatus()` - включение/выключение мониторинга
  - `GetMonitoringStatus()` - получение текущего состояния

#### 3. **Слой WebSocket (ws/)**

- **ws.go**: Потоковая передача метрик в реальном времени
  - Кэширование метрик для оптимизации производительности
  - Управление состоянием мониторинга
  - Три типа потоков: CPU, память, процессы
  - Автоматическое обновление кэша:
    - каждую секунду - для cpu
    - каждые пять секунд - для ОЗУ и процессов

**Ключевые особенности:**

- **Кэширование**: Метрики кэшируются для снижения нагрузки на систему
- **Управление состоянием**: Мониторинг можно включать/выключать через API
- **Потокобезопасность**: Использование мьютексов для безопасного доступа к данным
- **Graceful shutdown**: Корректное завершение WebSocket-соединений

#### 4. **Слой сбора метрик (getmetrics/)**

- **cpu_metrics.go**: Сбор метрик использования CPU
  - Поддержка мгновенных и усредненных значений
  - Использование библиотеки gopsutil
- **memory_metrics.go**: Сбор метрик использования памяти
  - Процент использования памяти
  - Используемая и общая память в мегабайтах
- **process_metrics.go**: Сбор информации о процессах
  - Получение списка всех процессов
  - Детальная информация: PID, имя, CPU%, память, статус и т.д.
  - Оптимизированная версия с лимитом процессов

#### 5. **Слой моделей (models/)**

- **process.go**: Структуры данных для API
  - `process_info` - информация о процессе
  - `cpu_metrics_response` - ответ с метриками CPU
  - `memory_metrics_response` - ответ с метриками памяти
  - `kill_process_by_id` - ответ при завершении процесса
  - `monitoring_status_request/response` - управление мониторингом

#### 6. **Слой middleware (middleware/)**

- **cors_middleware.go**: Обработка CORS заголовков
  - Поддержка GET и POST методов
  - Настройка разрешенных заголовков
  - Обработка preflight-запросов (OPTIONS)

### Поток данных

```
Клиент (Web)
    │
    ├─→ REST API (HTTP)
    │   ├─→ /api/gethostusername
    │   ├─→ /api/monitoring-status
    │   └─→ /api/kill-process-by-id
    │
    └─→ WebSocket
        ├─→ /ws/cpu
        ├─→ /ws/memory
        └─→ /ws/processes
            │
            ↓
    [Проверка состояния мониторинга]
            │
            ├─→ Мониторинг включен → Отправка реальных метрик из кэша
            └─→ Мониторинг выключен → Отправка сообщения о статусе
```

### Управление состоянием мониторинга

```
┌─────────────────────────────────────────┐
│  Клиент отправляет POST запрос          │
│  {"enabled": true/false}                │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────┐
│  SetMonitoringStatus()                  │
│  - Обновляет глобальное состояние       │
│  - Управляет горутиной сбора метрик    │
└──────────────┬──────────────────────────┘
               │
        ┌──────┴──────┐
        │             │
        ↓             ↓
┌──────────────┐  ┌──────────────┐
│ enabled=true │  │ enabled=false│
│              │  │              │
│ Запуск       │  │ Остановка    │
│ горутины     │  │ горутины     │
│ обновления   │  │ обновления   │
│ кэша         │  │ кэша         │
└──────────────┘  └──────────────┘
```

## API Эндпоинты

### REST API

REST API оставляет только вспомогательные операции, когда основной поток метрик приходит по WebSocket.

#### GET `/api/get-host-username`

Получение имени хоста и текущего пользователя.

**Ответ:**

```json
{
	"username": "user",
	"hostname": "mycomputer"
}
```

#### POST `/api/kill-process-by-id`

Завершение процесса по PID.

**Запрос:**

```json
{
	"pid": 1234
}
```

**Ответ:**

```json
{
	"pid": 1234,
	"message": "Процесс успешно завершен",
	"timestamp": "2024-01-15 14:30:25"
}
```

#### GET `/api/monitoring-status`

Получение текущего состояния мониторинга.

**Ответ:**

```json
{
	"enabled": true,
	"message": "Мониторинг включен",
	"timestamp": "2024-01-15 14:30:25"
}
```

#### POST `/api/monitoring-status`

Установка состояния мониторинга (включить/выключить).

**Запрос:**

```json
{
	"enabled": true
}
```

**Ответ:**

```json
{
	"enabled": true,
	"message": "Мониторинг успешно включен",
	"timestamp": "2024-01-15 14:30:25"
}
```

## WebSocket Эндпоинты

### `/ws/cpu`

Потоковая передача метрик CPU каждую секунду.

**Сообщения:**

```json
{
	"cpu": 45.2,
	"timestamp": "2024-01-15 14:30:25"
}
```

**При выключенном мониторинге:**

```json
{
	"monitoringEnabled": false,
	"message": "Мониторинг выключен"
}
```

### `/ws/memory`

Потоковая передача метрик памяти каждую секунду.

**Сообщения:**

```json
{
	"memoryUsage": 62.5,
	"usedMB": 8192,
	"totalMemory": 16384,
	"timestamp": "2024-01-15 14:30:25"
}
```

### `/ws/processes`

Потоковая передача списка процессов каждую секунду.

**Сообщения:**

```json
[
  {
    "pid": 1234,
    "name": "chrome",
    "cpuPercent": 15.5,
    ...
  }
]
```

## Технологический стек

- **Go 1.25.3** - основной язык программирования
- **gorilla/websocket v1.5.3** - WebSocket для потоковой передачи данных
- **gopsutil v4.25.10** - сбор системных метрик (CPU, память, процессы)
- **net/http** - стандартная библиотека для HTTP-сервера

## Запуск проекта

### Предварительные требования

- Go 1.25.3 или выше
- Linux, Windows или macOS

### Установка зависимостей

```bash
go mod download
```

### Запуск CLI-режима

```bash
go run main.go
```

В главном меню выберите:

- `1` - Работа с процессами (CLI)
- `2` - Раздел в разработке
- `3` - Запуск веб-сервера
- `0` - Выход

### Запуск веб-сервера

```bash
go run main.go
# Выберите опцию 3 в меню
```

Или напрямую через код:

```go
api.StartServer("8080")
```

Сервер будет доступен по адресу: `http://localhost:8080`

## Безопасность

- **CORS**: Настроен для работы с веб-приложениями (в продакшене рекомендуется указать конкретные домены)
- **Валидация**: Все входные данные валидируются перед обработкой
- **Graceful Shutdown**: Корректное завершение работы без потери данных
- **Таймауты**: Настроены таймауты для предотвращения зависаний

## Особенности реализации

### Оптимизация производительности

- Кэширование метрик для снижения нагрузки на систему
- Предварительное выделение памяти для слайсов
- Использование RWMutex для оптимизации чтения
- Синхронизация частоты обновления кэша с отправкой данных

### Управление ресурсами

- Graceful shutdown для корректного завершения работы
- Управление жизненным циклом горутин через контекст
- Автоматическая остановка сбора метрик при выключении мониторинга

### Обработка ошибок

- Полное логирование всех ошибок
- Информативные сообщения об ошибках для клиента
- Обработка ошибок сериализации JSON
- Валидация входных данных

## Жизненный цикл мониторинга

1. **Старт сервера**: Мониторинг выключен по умолчанию
2. **Включение мониторинга**: Клиент отправляет `POST /api/monitoring-status` с `{"enabled": true}`
3. **Запуск сбора метрик**: Запускается горутина обновления кэша каждую секунду
4. **Отправка данных**: WebSocket начинает отправлять реальные метрики
5. **Выключение мониторинга**: Клиент отправляет `POST /api/monitoring-status` с `{"enabled": false}`
6. **Остановка сбора**: Горутина останавливается, WebSocket отправляет сообщение о статусе

---

**Версия**: 1.0  
**Автор**: Roman Zhurakovskiy  
**Дата обновления**: 10.11.2025
